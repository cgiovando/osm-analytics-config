# analytics.json

This file defines which parts of the OpenStreetMap are to be analyzed by the osm-analytics-cruncher.

## Structure

The analytics.json file is divided into two sections: The first part defines what aspects of the OSM data should be considered for calculating the **experience** of OSM contributors, which is defined by the total amount of data that was last touched by the respective user and which matches a given filter.

The second part defines the **feature layers** that are to be generated by the cruncher. Each layer represents the OpenStreetMap data that matches a given filter. The experience fields (defined above) can be referenced from the feature layers, which will be used to enhance the output osm-analytics data (i.e. to each OSM building, the experience of the user who last touched the object is assigned).

Each feature layer also defines the **default style** which should be used when displaying the respective layer on a map.

```json
{
  "experienceFields": [
    /* list of experience field defintions*/
  ],
  "layers": [
    /* list of layer definitions */
  ]
}
```

### experience field

Example:

```json
{
  "name": "buildings",
  "filter": /* … */,
  "metric": "count"
}
```

Properties:

* `name` – identifier/name of the experience field
* `filter` – defines which part of all OSM features should be used to calculate this experience number (see below)
* `metric` – how to calculate the value for the given experience field can be either `count`, `length` or `area`

### layer

Example:

```json
{
  "name": "buildings",
  "title": "Buildings",
  "description": "Polygons with a building=* tag",
  "experienceField": "buildings",
  "filter":  /* … */,
  "render": {
    "type": "fill",
    "scaleBasis": 2.5,
    "scaleFactor": 200000,
    "defaultStyle": {
      "raw": /* mapbox gl styles */,
      "raw-highlight": /* mapbox gl styles */,
      "aggregated": /* mapbox gl styles */,
      "aggregated-highlight": /* mapbox gl styles */
    }
  }
}
```

Properties:

* `name` – identifier/name of the layer (used for example in osm-analytics URLs)
* `title` – title of the layer (used for example in the layer selector of osm-analytics.org)
* `description` – a description of the layer
* `experienceField` – defines which experience field should be used for this layer
* `filter` – defines which part of all OSM features should be used to calculate this experience number (see below)
* `processing` – (optional) if set, the specified list of pre-processing computations are applied for each OSM feature; currently the following algorithms are available: `"geometry:calculate_centroid"` (converts each OSM feature to a point placed at the centroid of the feature)
* `render` – defines how this layer should be displayed in the osm-analytics client
  - `type` – defines how the layer should be displayed at high (not-aggregated) zoom levels (can be `fill`, `line`, `circle`)
  - `scaleBasis` & `scaleFactor` – see "scaling properties" chapter below
  - `defaultStyle` – defines how the layer should be displayed by default on osm-analytics.org (i.e. if no theme is specified that overrides the styling of the layer); four different mapbox-gl layer styles have to be specified: `raw` is how the features are displayed at the high (non-aggregated) zoom levels, `aggregated` defines how the aggregated "grid" should be styled-


### filter

Example:

```json
"filter": {
  "tagKey": "building",
  "geometry": "Polygon"
}
```

Properties:
* `tagKey`: filters OSM features that have a tag with the given tag key (e.g. all OSM objects with a `building` tag)
* `tagValue`: filters OSM features that have a tag with the given tag key (see above) and value (e.g. all OSM objects with a `amenity=hospital` tag)
* `geometry`: filters OSM features that have the specified geometry type, can also be an array in which case multiple geometry types are allowed

### scaling properties

When rendering the density of real world features across different scales (from neighborhood level up to a global overview), as one wants the map to look more or less the same across all these many different zoom levels, it is necessary to define how the rendering properties should be calculated at each zoom level. This problem is well described in this [blog article by Eric Fischer](https://blog.mapbox.com/mapping-millions-of-dots-77eead9bd663). In the analyics definition file, this can be tweaked in the `scaleBasis` property. In practice, for countable features a scaling basis of about 2.5 produces good result for a variety of man made objects. For linear features (such as [waterways](https://agupubs.onlinelibrary.wiley.com/doi/pdf/10.1029/WR024i008p01317) or [roads](https://www.researchgate.net/profile/Yongmei_Lu3/publication/23541463_Fractal_dimension_of_a_transportation_network_and_its_relationship_with_urban_growth_A_study_of_the_Dallas-Fort_Worth_area/links/564e05dc08aeafc2aab16899/Fractal-dimension-of-a-transportation-network-and-its-relationship-with-urban-growth-A-study-of-the-Dallas-Fort-Worth-area.pdf)), scaling basis closer to 4 can produce good results.

The second scaling property is `scaleFactor` and is a global multiplicative factor to accommodate that different features types are more or less frequent (e.g. there are more buildings than schools on the world).

## Example

```json
{
  "experienceFields": [
    {
      "name": "buildings",
      "filter": {
        "tagKey": "building",
        "geometryType": "Polygon"
      },
      "metric": "count"
    }
  ],
  "layers": [
    {
      "name": "buildings",
      "title": "Buildings",
      "description": "Polygons with a building=* tag",
      "experienceField": "buildings",
      "filter": {
        "tagKey": "building",
        "geometry": "Polygon"
      },
      "render": {
        "type": "fill",
        "scaleBasis": 2.5,
        "scaleFactor": 200000,
        "defaultStyle": {
          "raw": {
            "fill-color": "#FDB863",
            "fill-outline-color": "#E08214"
          },
          "raw-highlight": {
            "fill-color": "#5CBAD8",
            "fill-outline-color": "#5CBAD8"
          },
          "aggregated": {
            "fill-color": "#FDB863"
          },
          "aggregated-highlight": {
            "fill-color": "#5CBAD8"
          }
        }
      }
    }
  ]
}
```
